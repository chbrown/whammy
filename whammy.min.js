var CLUSTER_MAX_DURATION=3E4;function makeCuePoint(a){return{id:187,data:[{id:179,data:a},{id:183,data:[{id:247,data:1},{id:241,data:0,size:8}]}]}}
function makeWebMStructure(a,c,b,d,f){a=[{id:357149030,data:[{id:2807729,data:1E6},{id:19840,data:"whammy"},{id:22337,data:"whammy"},{id:17545,data:doubleToString(a)}]},{id:374648427,data:[{id:174,data:[{id:215,data:1},{id:29637,data:1},{id:156,data:0},{id:2274716,data:"und"},{id:134,data:"V_VP8"},{id:2459272,data:"VP8"},{id:131,data:1},{id:224,data:[{data:c,id:176},{data:b,id:186}]}]}]},{id:475249515,data:d}];Array.prototype.push.apply(a,f);return[{id:440786851,data:[{id:17030,data:1},{id:17143,
data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:"webm"},{id:17031,data:2},{id:17029,data:2}]},{id:408125543,data:a}]}function makeCluster(a,c){var b=0,d=[{id:231,data:a}],f=c.map(function(a){var c=makeSimpleBlock({discardable:0,frame:a.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:b+.5|0});b+=a.duration;return{id:163,data:c}});Array.prototype.push.apply(d,f);return{id:524531317,data:d}}
function toWebM(a,c){void 0===c&&(c=!1);for(var b=checkFrames(a),d=[],f=[],e=0,g=0;e<a.length;){var h=g+.5|0,k=makeCuePoint(h);d.push(k);var l=[],k=0;do l.push(a[e]),k+=a[e].duration,e++;while(e<a.length&&k<CLUSTER_MAX_DURATION);h=makeCluster(h,l);f.push(h);g+=k}b=makeWebMStructure(b.duration,b.width,b.height,d,f);f=b[1];for(g=e=0;g<f.data.length;g++)3<=g&&(d[g-3].data[1].data[1].data=e),h=serializeEBML([f.data[g]],c),e+=h.size||h.byteLength||h.length,2!=g&&(f.data[g]=h);return serializeEBML(b,c)}
exports.toWebM=toWebM;function checkFrames(a){for(var c=a[0].width,b=a[0].height,d=a[0].duration,f=1,e;void 0!==(e=a[f]);f++){if(e.width!=c)throw"Frame "+(f+1)+" has an unusual width: "+e.width+"; it should be "+c;if(e.height!=b)throw"Frame "+(f+1)+" has an unusual height: "+e.height+"; it should be "+b;if(0>e.duration||32767<e.duration)throw"Frame "+(f+1)+" has a weird duration (must be between 0 and 32767)";d+=e.duration}return{duration:d,width:c,height:b}}
function numToBuffer(a){for(var c=[];0<a;)c.push(a&255),a>>=8;return new Uint8Array(c.reverse())}function numToFixedBuffer(a,c){for(var b=new Uint8Array(c),d=c-1;0<=d;d--)b[d]=a&255,a>>=8;return b}function strToBuffer(a){for(var c=new Uint8Array(a.length),b=0;b<a.length;b++)c[b]=a.charCodeAt(b);return c}function bitsToBuffer(a){var c=[];a=(a.length%8?Array(9-a.length%8).join("0"):"")+a;for(var b=0;b<a.length;b+=8)c.push(parseInt(a.substr(b,8),2));return new Uint8Array(c)}
function serializeEBML(a,c){for(var b=[],d=0,f;void 0!==(f=a[d]);d++)if("id"in f){var e=f.data;Array.isArray(e)&&(e=serializeEBML(e,c));if("number"==typeof e)var g=f.size,e=void 0!==g?numToFixedBuffer(e,g):bitsToBuffer(e.toString(2));"string"==typeof e&&(e=strToBuffer(e));var h=e.size||e.byteLength||e.length,g=Math.ceil(Math.ceil(Math.log(h)/Math.log(2))/8),h=h.toString(2),h=Array(7*g+8-h.length).join("0")+h,g=Array(g).join("0")+"1"+h;b.push(numToBuffer(f.id));b.push(bitsToBuffer(g));b.push(e)}else b.push(f);
return c?(b=flatten(b,[]),new Uint8Array(b)):new Blob(b,{type:"video/webm"})}function flatten(a,c){for(var b=0,d;void 0!==(d=a[b]);b++)Array.isArray(d)?flatten(d,c):c.push(d);return c}function makeSimpleBlock(a){var c=0;a.keyframe&&(c|=128);a.invisible&&(c|=8);a.lacing&&(c|=a.lacing<<1);a.discardable&&(c|=1);if(127<a.trackNum)throw"TrackNumber > 127 not supported";return[a.trackNum|128,a.timecode>>8,a.timecode&255,c].map(function(a){return String.fromCharCode(a)}).join("")+a.frame}
function parseWebP(a,c){for(var b=a.RIFF[0].WEBP[0],d=b.indexOf("\u009d\u0001*"),f=0,e=[];4>f;f++)e[f]=b.charCodeAt(d+3+f);d=e[1]<<8|e[0];f=d&16383;d=e[3]<<8|e[2];return{width:f,height:d&16383,data:b,riff:a,duration:c}}function format8bit(a){a=a.charCodeAt(0).toString(2);return Array(8-a.length+1).join("0")+a}
function parseRIFF(a){for(var c=0,b={};c<a.length;){var d=a.substr(c,4);b[d]=b[d]||[];if("RIFF"==d||"LIST"==d){var f=parseInt(a.substr(c+4,4).split("").map(format8bit).join(""),2),e=a.substr(c+8,f),c=c+(8+f);b[d].push(parseRIFF(e))}else{"WEBP"==d?b[d].push(a.substr(c+8)):b[d].push(a.substr(c+4));break}}return b}function doubleToString(a){a=new Uint8Array((new Float64Array([a])).buffer);for(var c=Array(8),b=0;8>b;b++)c[7-b]=String.fromCharCode(a[b]);return c.join("")}
var Video=function(){function a(a){void 0===a&&(a=[]);this.frames=a}a.prototype.compile=function(a){var b=this.frames.map(function(a){var c=parseRIFF(atob(a.image.slice(23)));return parseWebP(c,a.duration)});return toWebM(b,a)};Object.defineProperty(a.prototype,"duration",{get:function(){return this.frames.map(function(a){return a.duration}).reduce(function(a,b){return a+b},0)},enumerable:!0,configurable:!0});return a}();exports.Video=Video;
function fromImageArray(a,c,b){var d=1E3/c;a=a.map(function(a){return{image:a,duration:d}});return(new Video(a)).compile(b)}exports.fromImageArray=fromImageArray;
